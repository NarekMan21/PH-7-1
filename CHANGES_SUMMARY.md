# Сводка изменений

## Исправления на основе тестов

### 1. Прошивка ESP8266 (`esp8266_firmware.ino`)

**Изменения:**
- ✅ Обновлен IP адрес бэкенда с `192.168.2.127` на `192.168.0.31`
- ✅ Улучшена обработка ошибок WiFi (попытка подключения к резервной сети)
- ✅ Добавлен таймаут для HTTP запросов (5 секунд)
- ✅ Улучшено логирование ошибок Modbus (логирование каждые 10 ошибок)

**Настройки:**
```cpp
#define BACKEND_HOST    "192.168.0.31"
#define BACKEND_PORT    3000
#define BACKEND_URL     "http://192.168.0.31:3000/save"
```

### 2. Фронтенд - index.html

**Изменения:**
- ✅ Упрощена работа с датчиками - теперь данные берутся напрямую из бэкенда через `/api`
- ✅ Удалена система управления несколькими датчиками через localStorage
- ✅ Упрощен интерфейс - один датчик, данные из последней записи в базе
- ✅ Исправлена работа с графиками - правильная загрузка данных из `/history`
- ✅ Улучшена обработка ошибок подключения

**API эндпоинты:**
- `GET /api` - получение текущих данных (последняя запись)
- `GET /history` - получение истории данных

### 3. Фронтенд - charts.html

**Статус:** ✅ Уже правильно работает с `/history` API

**Функциональность:**
- Правильно обрабатывает формат ответа `{total, count, data}`
- Фильтрует данные по `v === true`
- Корректно обрабатывает timestamp и date поля

### 4. Бэкенд - backend.js

**Исправления (уже применены ранее):**
- ✅ Исправлена обработка отрицательных значений для `limit` и `offset`
- ✅ Правильная валидация параметров запроса

## Структура данных

### Формат данных от ESP8266:
```json
{
  "t": 25.5,      // Температура
  "h": 60.0,      // Влажность
  "ec": 1200,     // Электропроводность
  "ph": 6.5,      // pH
  "n": 150,       // Азот
  "p": 80,        // Фосфор
  "k": 200,       // Калий
  "v": true       // Валидность данных
}
```

### Формат данных в базе:
```json
{
  "timestamp": "2025-11-12T13:59:27.810Z",
  "date": "12.11.2025, 16:59:27",
  "ip": "192.168.0.31",
  "t": 25.5,
  "h": 60.0,
  "ec": 1200,
  "ph": 6.5,
  "n": 150,
  "p": 80,
  "k": 200,
  "v": true
}
```

### Формат ответа GET /history:
```json
{
  "total": 10,
  "count": 10,
  "data": [...]
}
```

## Инструкция по использованию

### 1. Загрузка прошивки на ESP8266

1. Откройте файл `esp8266_firmware.ino` в Arduino IDE
2. Установите необходимые библиотеки:
   - ESP8266WiFi
   - ESP8266WebServer
   - ESP8266HTTPClient
3. Выберите правильную плату (NodeMCU 1.0 или ваша модель ESP8266)
4. Загрузите прошивку на ESP8266

### 2. Настройка WiFi

В файле `esp8266_firmware.ino` обновите настройки WiFi:
```cpp
#define WIFI_SSID1      "ВАША_СЕТЬ"
#define WIFI_PASSWORD1  "ВАШ_ПАРОЛЬ"
```

### 3. Запуск бэкенда

```bash
npm start
```

Бэкенд будет доступен на `http://192.168.0.31:3000`

### 4. Доступ к веб-интерфейсу

- **Текущие показания:** `http://192.168.0.31:3000/index.html`
- **Графики:** `http://192.168.0.31:3000/charts.html`
- **API текущих данных:** `http://192.168.0.31:3000/api`
- **API истории:** `http://192.168.0.31:3000/history`

## Тестирование

Запустите тесты для проверки работоспособности:

```bash
# Тест бэкенда
node test-backend.js

# Тест GET /history
node test-history.js
```

## Важные замечания

1. **IP адрес:** Убедитесь, что IP адрес `192.168.0.31` соответствует IP вашего компьютера в локальной сети
2. **Firewall:** Убедитесь, что порт 3000 открыт в брандмауэре Windows
3. **WiFi:** ESP8266 и компьютер должны быть в одной сети WiFi
4. **Данные:** Данные сохраняются в файл `sensor_data.json` в корне проекта

## Решенные проблемы

✅ Исправлена обработка отрицательных значений limit/offset в GET /history
✅ Обновлен IP адрес бэкенда в прошивке
✅ Упрощена работа фронтенда с бэкендом
✅ Улучшена обработка ошибок в прошивке
✅ Правильная работа с форматом данных из тестов

