# Результаты тестирования GET /history

## Обзор
Проведено комплексное тестирование эндпоинта `GET /history` для проверки:
- ✅ Чтения данных
- ✅ Фильтрации (limit, offset)
- ✅ Формата ответа

## Результаты тестирования

### ✅ Пройдено: 5/7 тестов

#### ✅ Тест 1: Чтение пустой базы данных
- **Статус**: ПРОЙДЕН
- **Проверено**:
  - Структура ответа (total, count, data)
  - Значения для пустой базы (все равны 0)
  - Корректный формат JSON

#### ✅ Тест 2: Чтение данных (с данными)
- **Статус**: ПРОЙДЕН
- **Проверено**:
  - Структура ответа
  - Логическая согласованность (total === count === data.length)
  - Наличие всех обязательных полей в записях
  - Типы данных (timestamp, date, ip, t, h, ec, ph, n, p, k, v)
  - Валидность timestamp

#### ❌ Тест 3: Фильтрация по limit
- **Статус**: ПРОВАЛЕН (частично)
- **Проблема**: Отрицательные значения limit обрабатываются некорректно
- **Детали**:
  - ✅ `limit=1, 5, 10, 100, 0` - работают корректно
  - ❌ `limit=-5` - возвращает 5 записей вместо 10 (должен игнорироваться)

#### ❌ Тест 4: Фильтрация по offset
- **Статус**: ПРОВАЛЕН (частично)
- **Проблема**: Отрицательные значения offset обрабатываются некорректно
- **Детали**:
  - ✅ `offset=0, 2, 5, 8, 10` - работают корректно
  - ❌ `offset=-2` - возвращает 0 записей вместо 5 (должен быть обработан как 0)

#### ✅ Тест 5: Комбинированная фильтрация (limit + offset)
- **Статус**: ПРОЙДЕН
- **Проверено**:
  - Корректная работа комбинации limit и offset
  - Совпадение данных с ожидаемыми результатами
  - Правильная обработка граничных случаев

#### ✅ Тест 6: Формат ответа
- **Статус**: ПРОЙДЕН
- **Проверено**:
  - Статус код: 200
  - Content-Type: application/json; charset=utf-8
  - Структура JSON (объект с полями total, count, data)
  - Валидность JSON

#### ✅ Тест 7: Граничные случаи
- **Статус**: ПРОЙДЕН
- **Проверено**:
  - Обработка невалидных параметров (limit=abc, offset=xyz)
  - Обработка пустых параметров
  - Обработка параметров за пределами данных
  - Стабильность API при некорректных запросах

## Исправления

### Исправлена обработка отрицательных значений
В файле `backend.js` исправлена логика обработки параметров `limit` и `offset`:

```javascript
// До исправления:
const limit = parseInt(req.query.limit) || history.length;
const offset = parseInt(req.query.offset) || 0;

// После исправления:
const limitParam = parseInt(req.query.limit);
const offsetParam = parseInt(req.query.offset);

// Обрабатываем отрицательные и невалидные значения
const limit = (isNaN(limitParam) || limitParam <= 0) ? history.length : limitParam;
const offset = (isNaN(offsetParam) || offsetParam < 0) ? 0 : offsetParam;
```

## Формат ответа

Эндпоинт `GET /history` возвращает следующий формат:

```json
{
  "total": 10,        // Общее количество записей в базе
  "count": 5,         // Количество записей в текущем ответе
  "data": [           // Массив записей
    {
      "timestamp": "2025-11-12T13:59:27.810Z",
      "date": "12.11.2025, 16:59:27",
      "ip": "::1",
      "t": 25.5,
      "h": 60.0,
      "ec": 1200,
      "ph": 6.5,
      "n": 150,
      "p": 80,
      "k": 200,
      "v": true
    }
  ]
}
```

## Параметры запроса

- `limit` (опционально) - максимальное количество записей для возврата
  - Если не указан или <= 0, возвращаются все записи
  - Если указан отрицательный, обрабатывается как невалидный (возвращаются все записи)
  
- `offset` (опционально) - количество записей для пропуска
  - Если не указан или < 0, обрабатывается как 0
  - Если указан отрицательный, обрабатывается как 0

## Примеры использования

```bash
# Получить все записи
GET /history

# Получить первые 5 записей
GET /history?limit=5

# Пропустить первые 3 записи и получить следующие 5
GET /history?offset=3&limit=5

# Получить последние 3 записи (если всего 10 записей)
GET /history?offset=7&limit=3
```

## Важно

⚠️ **Для применения исправлений необходимо перезапустить сервер!**

После перезапуска все тесты должны пройти успешно.

## Запуск тестов

```bash
node test-history.js
```

Тесты автоматически:
- Создают резервную копию базы данных
- Подготавливают тестовые данные
- Выполняют все проверки
- Восстанавливают базу данных из резервной копии

