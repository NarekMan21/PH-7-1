#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <SoftwareSerial.h>
#include <ESP8266HTTPClient.h>

// ---------- –ù–ê–°–¢–†–û–ô–ö–ò WiFi ----------
#define WIFI_SSID1      "COMFAST_F8EB_2G"
#define WIFI_PASSWORD1  "15210625"
#define WIFI_SSID2      "Keenetic-1733"
#define WIFI_PASSWORD2  "m2HZ4Ceb"

// ---------- –ù–ê–°–¢–†–û–ô–ö–ò –ë–≠–ö–ï–ù–î–ê ----------
#define BACKEND_HOST    "192.168.0.31"  // IP –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
#define BACKEND_PORT    3000
#define BACKEND_URL    "http://192.168.2.127:3000/save"

ESP8266WebServer server(80);
WiFiClient wifiClient;

// RS485 –ø–∏–Ω—ã
#define RS485_RX_PIN    D5  // GPIO14
#define RS485_TX_PIN    D6  // GPIO12
#define RE_PIN          D1  // GPIO5
#define DE_PIN          D2  // GPIO4

// Modbus –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
#define SENSOR_ADDRESS       0x01
#define MODBUS_BAUDRATE      4800
#define MODBUS_START_REG     0x0000
#define MODBUS_READ_COUNT    0x0007     
#define MODBUS_RESPONSE_LEN  (3 + 2*MODBUS_READ_COUNT + 2) // 19 –±–∞–π—Ç
#define MODBUS_RESPONSE_TIMEOUT 1000    // –º—Å

SoftwareSerial rs485(RS485_RX_PIN, RS485_TX_PIN);

struct SensorData {
  float temperature;
  float humidity;
  float conductivity;
  float pH;
  float nitrogen;
  float phosphorus;
  float potassium;
  bool  valid;
} sensorData;

// CRC-16 Modbus
uint16_t calculateCRC(const uint8_t *data, uint8_t len) {
  uint16_t crc = 0xFFFF;
  for (uint8_t i = 0; i < len; i++) {
    crc ^= data[i];
    for (uint8_t j = 0; j < 8; j++) {
      if (crc & 0x0001) { crc >>= 1; crc ^= 0xA001; }
      else            { crc >>= 1; }
    }
  }
  return crc;
}

// –ß—Ç–µ–Ω–∏–µ —Å—Ä–∞–∑—É 7 —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ (T, H, EC, pH, N, P, K)
bool readAllParameters() {
  static unsigned long lastReadAttempt = 0;
  static uint8_t errorCount = 0;
  
  // –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞ –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º
  while (rs485.available()) {
    rs485.read();
    yield();
  }
  
  // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ Modbus –∑–∞–ø—Ä–æ—Å–∞
  uint8_t request[8] = {
    SENSOR_ADDRESS, 0x03,
    uint8_t(MODBUS_START_REG >> 8), uint8_t(MODBUS_START_REG & 0xFF),
    uint8_t(MODBUS_READ_COUNT >> 8), uint8_t(MODBUS_READ_COUNT & 0xFF),
    0x00, 0x00
  };
  uint16_t crc = calculateCRC(request, 6);
  request[6] = crc & 0xFF;
  request[7] = crc >> 8;

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
  digitalWrite(DE_PIN, HIGH);
  digitalWrite(RE_PIN, HIGH);
  delay(10);
  rs485.write(request, 8);
  rs485.flush();
  delay(5);
  digitalWrite(DE_PIN, LOW);
  digitalWrite(RE_PIN, LOW);
  delay(5);

  // –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
  uint8_t response[MODBUS_RESPONSE_LEN];
  uint8_t idx = 0;
  unsigned long start = millis();
  
  while (millis() - start < MODBUS_RESPONSE_TIMEOUT && idx < MODBUS_RESPONSE_LEN) {
    if (rs485.available()) {
      response[idx++] = rs485.read();
      start = millis();
    }
    yield();
  }
  
  if (idx == 0) {
    errorCount++;
    Serial.printf("‚ùå Modbus: –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –¥–∞—Ç—á–∏–∫–∞ (–ø–æ–ø—ã—Ç–∫–∞ %d)\n", errorCount);
    return false;
  }
  
  if (idx != MODBUS_RESPONSE_LEN) {
    errorCount++;
    Serial.printf("‚ùå Modbus: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–∞–∫–µ—Ç (%d –±–∞–π—Ç –∏–∑ %d, –ø–æ–ø—ã—Ç–∫–∞ %d)\n", idx, MODBUS_RESPONSE_LEN, errorCount);
    return false;
  }
  
  if (errorCount > 0) {
    Serial.printf("‚úÖ –°–≤—è–∑—å —Å –¥–∞—Ç—á–∏–∫–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (–±—ã–ª–æ %d –æ—à–∏–±–æ–∫)\n", errorCount);
    errorCount = 0;
  }

  uint16_t respCrc = calculateCRC(response, MODBUS_RESPONSE_LEN - 2);
  if (response[MODBUS_RESPONSE_LEN-2] != (respCrc & 0xFF) ||
      response[MODBUS_RESPONSE_LEN-1] != (respCrc >> 8)) {
    Serial.println("‚ùå Modbus: –Ω–µ–≤–µ—Ä–Ω–∞—è CRC");
    return false;
  }

  uint16_t raw[7];
  for (uint8_t i = 0; i < 7; i++) {
    raw[i] = (response[3 + 2*i] << 8) | response[3 + 2*i + 1];
  }
  sensorData.humidity     = raw[0] / 10.0f;
  sensorData.temperature  = raw[1] / 10.0f;
  sensorData.conductivity = raw[2];
  sensorData.pH           = raw[3] / 10.0f;
  sensorData.nitrogen     = raw[4];
  sensorData.phosphorus   = raw[5];
  sensorData.potassium    = raw[6];
  sensorData.valid        = true;
  
  // –í—ã–≤–æ–¥ –ø–æ–∫–∞–∑–∞–Ω–∏–π –≤ Serial Monitor
  printSensorData();
  
  return true;
}

void printSensorData() {
  if (sensorData.valid) {
    Serial.println("\n========== –ü–û–ö–ê–ó–ê–ù–ò–Ø –î–ê–¢–ß–ò–ö–ê ==========");
    Serial.printf("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:     %.1f¬∞C\n", sensorData.temperature);
    Serial.printf("–í–ª–∞–∂–Ω–æ—Å—Ç—å:       %.1f%%\n", sensorData.humidity);
    Serial.printf("–≠–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–Ω–æ—Å—Ç—å: %.0f ¬µS/cm\n", sensorData.conductivity);
    Serial.printf("pH:              %.1f\n", sensorData.pH);
    Serial.printf("–ê–∑–æ—Ç (N):        %.0f mg/kg\n", sensorData.nitrogen);
    Serial.printf("–§–æ—Å—Ñ–æ—Ä (P):      %.0f mg/kg\n", sensorData.phosphorus);
    Serial.printf("–ö–∞–ª–∏–π (K):       %.0f mg/kg\n", sensorData.potassium);
    Serial.println("=======================================\n");
  } else {
    Serial.println("‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞");
  }
}

void setup() {
  Serial.begin(115200);
  delay(10);
  Serial.println("\n\n=======================================");
  Serial.println("    PH-7-1 –î–∞—Ç—á–∏–∫ –ø–æ—á–≤—ã ESP8266");
  Serial.println("=======================================\n");
  
  pinMode(DE_PIN, OUTPUT);
  pinMode(RE_PIN, OUTPUT);
  digitalWrite(DE_PIN, LOW);
  digitalWrite(RE_PIN, LOW);
  rs485.begin(MODBUS_BAUDRATE);
  Serial.println("‚úÖ RS485 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
  Serial.printf("   –°–∫–æ—Ä–æ—Å—Ç—å: %d –±–æ–¥\n", MODBUS_BAUDRATE);
  Serial.printf("   RX: GPIO%d (D%d)\n", RS485_RX_PIN, RS485_RX_PIN);
  Serial.printf("   TX: GPIO%d (D%d)\n", RS485_TX_PIN, RS485_TX_PIN);
  Serial.printf("   DE: GPIO%d (D%d)\n", DE_PIN, DE_PIN);
  Serial.printf("   RE: GPIO%d (D%d)\n", RE_PIN, RE_PIN);
  Serial.printf("   –ê–¥—Ä–µ—Å –¥–∞—Ç—á–∏–∫–∞: 0x%02X\n", SENSOR_ADDRESS);
  
  sensorData.valid = false;
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WiFi
  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID1, WIFI_PASSWORD1);
  Serial.print("üì∂ WiFi –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println();
  Serial.print("‚úÖ WiFi –ø–æ–¥–∫–ª—é—á–µ–Ω! IP –∞–¥—Ä–µ—Å: ");
  Serial.println(WiFi.localIP());
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
  server.on("/", handleRoot);
  server.on("/api", handleAPI);
  server.begin();
  Serial.println("üåê HTTP –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω");
  Serial.print("   –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://");
  Serial.println(WiFi.localIP());
  Serial.print("   JSON API: http://");
  Serial.print(WiFi.localIP());
  Serial.println("/api");
  Serial.print("   –ë—ç–∫–µ–Ω–¥: ");
  Serial.println(BACKEND_URL);
  
  Serial.println("\n–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞. –û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞...\n");
}

// HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–ª–µ–≥–∫–∞—è –∏ —á–∏—Å—Ç–∞—è)
const char htmlPage[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PH-7-1 –î–∞—Ç—á–∏–∫ –ø–æ—á–≤—ã</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff; min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            text-align: center; margin-bottom: 30px; padding: 20px;
            background: rgba(255, 255, 255, 0.1); border-radius: 15px; backdrop-filter: blur(10px);
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .status {
            display: inline-block; padding: 8px 16px; border-radius: 20px;
            font-size: 0.9em; font-weight: 600; margin-top: 10px;
        }
        .status.online { background: #4caf50; color: #fff; }
        .status.offline { background: #f44336; color: #fff; }
        .grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.15); border-radius: 15px; padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2); }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .card-title { font-size: 1.1em; font-weight: 600; color: #fff; }
        .card-icon { font-size: 2em; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255, 255, 255, 0.2); }
        .card-value { font-size: 2.5em; font-weight: 700; margin: 15px 0; color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); }
        .card-unit { font-size: 0.5em; opacity: 0.8; margin-left: 5px; }
        .card-footer { font-size: 0.85em; opacity: 0.7; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .footer { text-align: center; padding: 20px; opacity: 0.8; font-size: 0.9em; }
        .loading { text-align: center; padding: 40px; font-size: 1.2em; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            .card-value { font-size: 2em; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± PH-7-1 –î–∞—Ç—á–∏–∫ –ø–æ—á–≤—ã</h1>
            <p>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ—á–≤—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
            <div id="status" class="status offline">–û–§–õ–ê–ô–ù</div>
        </div>
        <div id="content"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div></div>
        <div class="footer">ESP8266 PH-7-1 Sensor | <span id="ip">--</span> | –û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="lastUpdate">--</span></div>
    </div>
    <script>
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ru-RU');
        }
        function updateData() {
            fetch('/api')
                .then(response => response.json())
                .then(data => {
                    const content = document.getElementById('content');
                    const status = document.getElementById('status');
                    const lastUpdate = document.getElementById('lastUpdate');
                    if (data.v && data.v === true) {
                        status.textContent = '–û–ù–õ–ê–ô–ù';
                        status.className = 'status online';
                        content.innerHTML = '<div class="grid"><div class="card"><div class="card-header"><span class="card-title">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span><div class="card-icon">üå°Ô∏è</div></div><div class="card-value">' + data.t.toFixed(1) + '<span class="card-unit">¬∞C</span></div><div class="card-footer"><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span></div></div><div class="card"><div class="card-header"><span class="card-title">–í–ª–∞–∂–Ω–æ—Å—Ç—å</span><div class="card-icon">üíß</div></div><div class="card-value">' + data.h.toFixed(1) + '<span class="card-unit">%</span></div><div class="card-footer"><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span></div></div><div class="card"><div class="card-header"><span class="card-title">–≠–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–Ω–æ—Å—Ç—å</span><div class="card-icon">‚ö°</div></div><div class="card-value">' + Math.round(data.ec) + '<span class="card-unit">¬µS/cm</span></div><div class="card-footer"><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span></div></div><div class="card"><div class="card-header"><span class="card-title">pH</span><div class="card-icon">üß™</div></div><div class="card-value">' + data.ph.toFixed(1) + '<span class="card-unit"></span></div><div class="card-footer"><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span></div></div><div class="card"><div class="card-header"><span class="card-title">–ê–∑–æ—Ç (N)</span><div class="card-icon">N</div></div><div class="card-value">' + Math.round(data.n) + '<span class="card-unit">mg/kg</span></div><div class="card-footer"><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span></div></div><div class="card"><div class="card-header"><span class="card-title">–§–æ—Å—Ñ–æ—Ä (P)</span><div class="card-icon">P</div></div><div class="card-value">' + Math.round(data.p) + '<span class="card-unit">mg/kg</span></div><div class="card-footer"><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span></div></div><div class="card"><div class="card-header"><span class="card-title">–ö–∞–ª–∏–π (K)</span><div class="card-icon">K</div></div><div class="card-value">' + Math.round(data.k) + '<span class="card-unit">mg/kg</span></div><div class="card-footer"><span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</span></div></div></div>';
                        lastUpdate.textContent = formatTime(Date.now());
                        if (data.ip) document.getElementById('ip').textContent = data.ip;
                    } else {
                        status.textContent = '–û–§–õ–ê–ô–ù';
                        status.className = 'status offline';
                        content.innerHTML = '<div class="card"><div class="card-header"><span class="card-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span><div class="card-icon">‚ö†Ô∏è</div></div><div class="card-value">--<span class="card-unit"></span></div><div class="card-footer"><span>–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞</span></div></div>';
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                    const status = document.getElementById('status');
                    status.textContent = '–û–®–ò–ë–ö–ê';
                    status.className = 'status offline';
                });
        }
        setInterval(updateData, 2000);
        updateData();
    </script>
</body>
</html>
)rawliteral";

void handleRoot() {
  server.send(200, "text/html; charset=utf-8", htmlPage);
}

void handleAPI() {
  server.sendHeader("Access-Control-Allow-Origin", "*");
  if (!sensorData.valid) {
    server.send(200, "application/json", "{\"v\":false,\"error\":\"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö\"}");
    return;
  }
  String json = "{";
  json += "\"t\":" + String(sensorData.temperature, 1) + ",";
  json += "\"h\":" + String(sensorData.humidity, 1) + ",";
  json += "\"ec\":" + String(sensorData.conductivity, 0) + ",";
  json += "\"ph\":" + String(sensorData.pH, 1) + ",";
  json += "\"n\":" + String(sensorData.nitrogen, 0) + ",";
  json += "\"p\":" + String(sensorData.phosphorus, 0) + ",";
  json += "\"k\":" + String(sensorData.potassium, 0) + ",";
  json += "\"v\":true,";
  json += "\"ip\":\"" + WiFi.localIP().toString() + "\"";
  json += "}";
  server.send(200, "application/json", json);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –±—ç–∫–µ–Ω–¥
void sendToBackend() {
  if (!sensorData.valid) {
    return;
  }
  
  static unsigned long lastSendTime = 0;
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
  if (millis() - lastSendTime < 30000) {
    return;
  }
  lastSendTime = millis();
  
  HTTPClient http;
  http.begin(wifiClient, BACKEND_URL);
  http.addHeader("Content-Type", "application/json");
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º JSON
  String json = "{";
  json += "\"t\":" + String(sensorData.temperature, 1) + ",";
  json += "\"h\":" + String(sensorData.humidity, 1) + ",";
  json += "\"ec\":" + String(sensorData.conductivity, 0) + ",";
  json += "\"ph\":" + String(sensorData.pH, 1) + ",";
  json += "\"n\":" + String(sensorData.nitrogen, 0) + ",";
  json += "\"p\":" + String(sensorData.phosphorus, 0) + ",";
  json += "\"k\":" + String(sensorData.potassium, 0) + ",";
  json += "\"v\":true";
  json += "}";
  
  int httpCode = http.POST(json);
  
  if (httpCode > 0) {
    if (httpCode == HTTP_CODE_OK) {
      Serial.println("‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –±—ç–∫–µ–Ω–¥");
    } else {
      Serial.printf("‚ö†Ô∏è –ë—ç–∫–µ–Ω–¥ –≤–µ—Ä–Ω—É–ª –∫–æ–¥: %d\n", httpCode);
    }
  } else {
    Serial.printf("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥: %s\n", http.errorToString(httpCode).c_str());
  }
  
  http.end();
}

void loop() {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
  server.handleClient();
  
  // –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞ (–∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã)
  static unsigned long lastReadTime = 0;
  if (millis() - lastReadTime >= 2000) {
    lastReadTime = millis();
    bool readSuccess = readAllParameters();
    if (!readSuccess) {
      sensorData.valid = false;
    } else {
      // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –±—ç–∫–µ–Ω–¥
      sendToBackend();
    }
  }
  
  delay(10);
}
